const t={fps:0,fft:11,minDB:-100,maxDB:-30,smooth:0,scale:1};class s{constructor(s,i,e){return this.analyserNodes=[],this.audioInfo={},this.data=[],this.rAF=null,this.settings={...t,...e},this.framerate=0,this.lastTick=performance.now(),this.canvasWorker=i,this.sab=new SharedArrayBuffer(98304),this.setSource(s)}setSource(t){let s,i;if(t){t.tagName?(s=new AudioContext,t=s.createMediaElementSource(t)):s=t.context,i=s.createChannelSplitter(t.channelCount),t.connect(i);for(let e=0,a=t.channelCount;e<a;e++)this.analyserNodes[e]=s.createAnalyser(),this.analyserNodes[e].fftSize=Math.pow(2,this.settings.fft),this.analyserNodes[e].minDecibels=this.settings.minDB,this.analyserNodes[e].maxDecibels=this.settings.maxDB,this.analyserNodes[e].smoothingTimeConstant=this.settings.smooth,i.connect(this.analyserNodes[e],e,0);return t.connect(s.destination),this.sendAudioInfo(s),this.setFPS(this.settings.fps),this}}loopRAF(){this.rAF=requestAnimationFrame((()=>{this.loopRAF()})),this.loop()}loopTimer(){this.getFramerate(),this.loop()}getFramerate(){const t=performance.now();this.framerate=1e3/(t-this.lastTick),this.lastTick=t}loop(){const t=this.analyserNodes[0].fftSize+this.analyserNodes[0].frequencyBinCount;let s=new Uint8Array(this.sab);for(let i=0;i<this.analyserNodes.length;i++){let e=new Uint8Array(this.analyserNodes[i].fftSize);this.analyserNodes[i].getByteTimeDomainData(e),s.set(e,i*t),e=new Uint8Array(this.analyserNodes[i].frequencyBinCount),this.analyserNodes[i].getByteFrequencyData(e),s.set(e,i*t+this.analyserNodes[i].fftSize)}this.canvasWorker.postMessage("process")}sendAudioInfo(t){this.canvasWorker.postMessage({audioInfo:{fftSize:this.analyserNodes[0].fftSize,minDB:this.analyserNodes[0].minDecibels,maxDB:this.analyserNodes[0].maxDecibels,smooth:this.analyserNodes[0].smoothingTimeConstant,sampleRate:t?.sampleRate,channels:t?.destination.channelCount,sab:this.sab}})}setFPS(t){this.rAF&&(0===this.fps?cancelAnimationFrame(this.rAF):clearInterval(this.rAF),this.rAF=null),0===t?(this.rAF=requestAnimationFrame((()=>{this.loopRAF()})),this.framerate="MAX"):this.rAF=setInterval((()=>{this.loopTimer()}),1e3/t),this.fps=t}}const i={fps:0,fft:11,minDB:-100,maxDB:-30,smooth:0,scale:1};class e{constructor(t,e,a){this.canvasWorker=new Worker(URL.createObjectURL(new Blob(['\nclass Waveform{constructor(t,i=0,s=0,h=t.canvas.width,e=t.canvas.height){this.ctx=t,this.x=i,this.y=s,this.width=h,this.height=e,this.strokeBG="rgba(0, 100, 0, 255)",this.strokeFG="rgba(0, 255, 0, 255)"}clear(){const t=this.ctx;t.fillStyle="rgba(0, 0, 0, 255)",t.fillRect(this.x,this.y,this.width,this.height)}drawFG(){const t=new Uint8Array(this.sab),i=this.ctx,s=this.width;this.height;i.beginPath(),i.lineWidth=2,i.strokeStyle=this.strokeFG;const h=s/this.fftSize;for(let s=0,e=this.channels;s<e;s++){let e,a=this.y+(s+.5)*this.chHigh;i.moveTo(this.x,a);for(let n=0,l=this.fftSize;n<l;n++)e=(t[s*this.fftSize*1.5+n]-128)/128,a=this.y+(s+.5)*this.chHigh+e*this.ampHigh,i.lineTo(this.x+n*h,a)}i.stroke()}setAudio(t){this.sab=t.sab,this.fftSize=t.fftSize,t.channels&&(this.channels=t.channels,this.chHigh=this.height/t.channels,this.ampHigh=this.chHigh/2)}}function makeColorMap(t){const i=new OffscreenCanvas(256,1).getContext("2d",{alpha:!1,willReadFrequently:!0}),s=i.createLinearGradient(0,0,256,0),h=1/(t.length-1);let e=0;t.forEach((t=>{s.addColorStop(e,t),e+=h})),i.fillStyle=s,i.fillRect(0,0,256,1);let a=[];for(let t=0;t<256;t++)a[t]=n(t);return a;function n(t){const s=i.getImageData(t,0,1,1).data;return"rgb("+s[0]+","+s[1]+","+s[2]+")"}}class Spectrogram{constructor(t,i="LOG",s="A",h=0,e=0,a=t.canvas.width,n=t.canvas.height){this.ctx=t,this.x=h,this.y=e,this.width=a,this.height=n,this.colorMap=makeColorMap(["#000000","#0000a0","#6000a0","#962761","#dd1440","#f0b000","#ffffa0","#ffffff"]),this.tempCanvas=new OffscreenCanvas(this.width,this.height),this.tempCtx=this.tempCanvas.getContext("2d",{alpha:!1}),this.MODE=i,this.WEIGHTING=s,this.hCoeff=.2*this.height,this.bins=1024,this.nyquist=24e3,this.maxHearableBin=1023,this.lastData=[];const l=this.makeBinFreqs();this._aWeightingLUT=l.map((t=>.5+.5*this._getAWeighting(t)))}clear(){const t=this.ctx;t.fillStyle="rgb(0, 0, 0)",t.fillRect(this.x,this.y,this.width,this.height)}drawFG(){const t=new Uint8Array(this.sab),i=this.ctx,s=this.width,h=this.hCoeff,e=(this.bins,s/(this.maxHearableBin-1));if("LINEAR"===this.MODE)for(let s=0;s<=this.maxHearableBin;s++){let a=Math.max(t[this.fftSize+s],t[2.5*this.fftSize+s]);const n=this.colorMap[a],l=("A"===this.WEIGHTING?this._aWeightingLUT[s]/1.4:1)*a/256*h|0,r=s*e;i.fillStyle=n,i.fillRect(this.x+r,this.y+h-l,e,l),this.tempCtx.fillStyle=n,this.tempCtx.fillRect(r,0,e,2)}else if("LOG"===this.MODE){const e=Math.log(this.maxHearableBin);for(let a=0;a<=this.maxHearableBin;a++){const n=Math.log(a+1)/e*s|0,l=Math.log(a+2)/e*s-n|0,r=("A"===this.WEIGHTING?this._aWeightingLUT[a]/1.4:1)*t[a]/256*h|0,o=this.colorMap[Math.max(t[this.fftSize+a],t[2.5*this.fftSize+a],0)];i.fillStyle=o,i.fillRect(this.x+n,this.y+h-r,l,r),this.tempCtx.fillStyle=o,this.tempCtx.fillRect(n,0,l,2)}}else if("CONSTANT_Q"===this.MODE&&!dataHeap.every((t=>0===t))){this.lib._cqt_calc(this.dataPtr,this.dataPtr),this.lib._cqt_render_line(this.dataPtr);for(let t=0;t<canvasWidth;t++){const s=255*("A"===WEIGHTING?_aWeightingLUT[t]:1)*dataHeap[t]|0,e=s*h|0,a=getColor(s);i.fillStyle=a,i.fillRect(this.x+t,this.y+fqHeight-e,1,e),this.tempCtx.fillStyle=a,this.tempCtx.fillRect(t,0,1,2)}}this.tempCtx.translate(0,2),this.tempCtx.drawImage(this.tempCanvas,0,0),this.tempCtx.setTransform(1,0,0,1,0,0),i.drawImage(this.tempCanvas,this.x,this.y+h)}setAudio(t){this.fftSize=t.fftSize,this.bins=t.fftSize/2,t.channels&&(this.nyquist=t.sampleRate/2,this.channels=t.channels);const i=this.makeBinFreqs();this._aWeightingLUT=i.map((t=>.5+.5*this._getAWeighting(t))),this.sab=t.sab}_getAWeighting(t){const i=t*t;return 281061254.916*i*i/((i+424.36)*Math.sqrt((i+11599.29)*(i+544496.41))*(i+14884e4))}isRepeatedFrequencyData(t){let i=!0;for(let s=0;s<this.bins;s+=16)t[s]!==this.lastData[s]&&(i=!1),this.lastData[s]=t[s];return i}cqt_bin_to_freq(t,i,s){const h=Math.log(i),e=Math.log(s);return Math.exp(h+(t+.5)*(e-h)*(1/width))}makeBinFreqs(){const t=[];for(let i=0;i<this.bins;i++)t[i]=i/this.bins*this.nyquist,t[i]<2e4&&(this.maxHearableBin=i);return t}}class Goniometer{constructor(t,i,s,h,e){this.ctx=t,this.x=i||0,this.y=s||0,this.width=h||t.canvas.width,this.height=e||t.canvas.height,this.strokeBG="rgba(208, 130, 34, 255)",this.strokeFG="rgba(230, 200, 32, 255)"}clear(){const t=this.ctx;t.fillStyle="rgba(0, 0, 0, 1)",t.fillRect(this.x,this.y,this.width,this.height)}drawFG(){const t=new Uint8Array(this.sab),i=this.ctx,s=this.width,h=this.height;let e;i.lineWidth=1,i.strokeStyle=this.strokeFG,i.beginPath(),e=this.rotate45deg(this.toFloat(t[1.5*this.fftSize]),this.toFloat(t[0])),i.moveTo(this.x+e.x*s+s/2,this.y+e.y*h+h/2);for(let a=1;a<this.fftSize;a++)e=this.rotate45deg(this.toFloat(t[1.5*this.fftSize+a]),this.toFloat(t[a])),i.lineTo(this.x+e.x*s+s/2,this.y+e.y*h+h/2);i.stroke()}setAudio(t){this.fftSize=t.fftSize,this.sab=t.sab}toFloat(t){return(t-128)/256/1.414213}rotate45deg(t,i){const s=this.cartesian2polar(t,i);s.angle-=.78539816;const h=this.polar2cartesian(s.radius,s.angle);return{x:h.x,y:h.y}}cartesian2polar(t,i){return{radius:Math.sqrt(t*t+i*i),angle:Math.atan2(i,t)}}polar2cartesian(t,i){return{x:t*Math.sin(i),y:t*Math.cos(i)}}}let viz=[];onmessage=function(t){if("process"!==t.data){if(t.data.canvas){const i=t.data.canvas.getContext("2d");return viz.push(new Goniometer(i,0,0,i.canvas.width/2,i.canvas.width/2)),viz.push(new Spectrogram(i,"LINEAR","A",i.canvas.width/2,0,i.canvas.width/2,i.canvas.width/2)),void viz.push(new Waveform(i,0,i.canvas.width/2,i.canvas.width,i.canvas.height-i.canvas.width/2))}if(t.data.audioInfo)for(let i=0;i<viz.length;i++)viz[i].setAudio(t.data.audioInfo);else console.error("Unknown message:",t.data)}else for(let t=0;t<viz.length;t++)viz[t].clear(),viz[t].drawFG()};\n'],{type:"text/javascript"})),{type:"module"}),this.audioSource=t,this.settings={...i,...a},e.width=screen.width*this.settings.scale,e.height=screen.height*this.settings.scale,e.style.cssText="user-select:none;",e.ondblclick=t=>{e.requestFullscreen()},e.onfullscreenchange=t=>{document.fullscreenElement?e.style.cursor="none":e.style.cursor="inherit"};const h=e.transferControlToOffscreen();return this.canvasWorker.postMessage({canvas:h},[h]),this.analyzer=new s(this.audioSource,this.canvasWorker,this.settings),this}}export{e as Visualizer};