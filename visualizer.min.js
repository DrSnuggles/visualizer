const t={fps:0,fft:11,minDB:-100,maxDB:-30,smooth:0,scale:1};class s{constructor(s,i,e){return this.analyserNodes=[],this.audioInfo={},this.data=[],this.rAF=null,this.settings={...t,...e},this.framerate=0,this.lastTick=performance.now(),this.canvasWorker=i,this.sab32=new ArrayBuffer(65536),this.sab8=new ArrayBuffer(16384),this.sab=!1,this.setSource(s)}setSource(t){let s,i;if(t){t.tagName?(s=new AudioContext,t=s.createMediaElementSource(t)):s=t.context,t.numberOfOutputs<2?(i=s.createChannelSplitter(t.channelCount),t.connect(i)):i=t;for(let t=0,e=2;t<e;t++)this.analyserNodes[t]=s.createAnalyser(),this.analyserNodes[t].fftSize=Math.pow(2,this.settings.fft),this.analyserNodes[t].minDecibels=this.settings.minDB,this.analyserNodes[t].maxDecibels=this.settings.maxDB,this.analyserNodes[t].smoothingTimeConstant=this.settings.smooth,i.connect(this.analyserNodes[t],t,0);return this.analyserNode=s.createAnalyser(),this.analyserNode.fftSize=Math.pow(2,this.settings.fft),this.analyserNode.minDecibels=this.settings.minDB,this.analyserNode.maxDecibels=this.settings.maxDB,this.analyserNode.smoothingTimeConstant=this.settings.smooth,t.connect(this.analyserNode),t.connect(s.destination),this.sendAudioInfo(s),this.setFPS(this.settings.fps),this}}loopRAF(){this.rAF=requestAnimationFrame((()=>{this.loopRAF()})),this.getFramerate(),this.loop()}loopTimer(){this.getFramerate(),this.loop()}getFramerate(){const t=performance.now();this.framerate=(this.framerate+1e3/(t-this.lastTick))/2,this.lastTick=t}loop(){const t=this.analyserNodes[0].fftSize;let s=new Uint8Array(this.sab8),i=new Float32Array(this.sab32),e=new Float32Array(this.analyserNodes[0].fftSize);for(let s=0;s<this.analyserNodes.length;s++)this.analyserNodes[s].getFloatTimeDomainData(e),i.set(e,s*t);e=new Uint8Array(this.analyserNode.frequencyBinCount),this.analyserNode.getByteFrequencyData(e),s.set(e,0),this.sab?this.canvasWorker.postMessage({process:[]}):this.canvasWorker.postMessage({process:[i,s]})}sendAudioInfo(t){this.canvasWorker.postMessage({audioInfo:{fftSize:this.analyserNodes[0].fftSize,minDB:this.analyserNodes[0].minDecibels,maxDB:this.analyserNodes[0].maxDecibels,smooth:this.analyserNodes[0].smoothingTimeConstant,sampleRate:t?.sampleRate,channels:t?.destination.channelCount,sab32:this.sab32,sab8:this.sab8}})}setFPS(t){this.rAF&&(0===this.fps?cancelAnimationFrame(this.rAF):clearInterval(this.rAF),this.rAF=null),this.rAF=0===t?requestAnimationFrame((()=>{this.loopRAF()})):setInterval((()=>{this.loopTimer()}),1e3/t),this.fps=t}}const i={fps:0,fft:0,minDB:-100,maxDB:-30,smooth:0,scale:1};class e{constructor(t,e,a){this.canvasWorker=new Worker(URL.createObjectURL(new Blob(['\nclass Waveform{constructor(t,i=0,s=0,e=t.canvas.width,h=t.canvas.height){this.ctx=t,this.x=i,this.y=s,this.width=e,this.height=h,this.strokeBG="rgba(0, 100, 0, 255)",this.strokeFG="rgba(0, 255, 0, 255)"}clear(){const t=this.ctx;t.fillStyle="rgba(0, 0, 0, 255)",t.fillRect(this.x,this.y,this.width,this.height)}drawFG(t){const i=t||new Float32Array(this.sab),s=this.ctx,e=this.width;this.height;s.beginPath(),s.lineWidth=2,s.strokeStyle=this.strokeFG;const h=e/this.fftSize;for(let t=0,e=this.channels;t<e;t++){let e=i[t*this.fftSize+0],a=this.y+(t+.5)*this.chHigh+e*this.ampHigh;s.moveTo(this.x,a);for(let n=0,r=this.fftSize;n<r;n++)e=i[t*this.fftSize+n],a=this.y+(t+.5)*this.chHigh+e*this.ampHigh,s.lineTo(this.x+(n+1)*h,a)}s.stroke()}setAudio(t){this.sab=t.sab32,this.fftSize=t.fftSize,t.channels&&(this.channels=t.channels,this.chHigh=this.height/t.channels,this.ampHigh=this.chHigh/2)}}function makeColorMap(t){const i=new OffscreenCanvas(256,1).getContext("2d",{alpha:!1,willReadFrequently:!0}),s=i.createLinearGradient(0,0,256,0),e=1/(t.length-1);let h=0;t.forEach((t=>{s.addColorStop(h,t),h+=e})),i.fillStyle=s,i.fillRect(0,0,256,1);let a=[];for(let t=0;t<256;t++)a[t]=n(t);return a;function n(t){const s=i.getImageData(t,0,1,1).data;return"rgb("+s[0]+","+s[1]+","+s[2]+")"}}class Spectrogram{constructor(t,i="LOG",s="A",e=0,h=0,a=t.canvas.width,n=t.canvas.height){this.ctx=t,this.x=e,this.y=h,this.width=a,this.height=n,this.colorMap=makeColorMap(["#000000","#0000a0","#6000a0","#962761","#dd1440","#f0b000","#ffffa0","#ffffff"]),this.tempCanvas=new OffscreenCanvas(this.width,this.height),this.tempCtx=this.tempCanvas.getContext("2d",{alpha:!1}),this.MODE=i,this.WEIGHTING=s,this.hCoeff=.2*this.height,this.bins=1024,this.nyquist=24e3,this.maxHearableBin=1023,this.lastData=[];const r=this.makeBinFreqs();this._aWeightingLUT=r.map((t=>.5+.5*this._getAWeighting(t)))}clear(){const t=this.ctx;t.fillStyle="rgb(0, 0, 0)",t.fillRect(this.x,this.y,this.width,this.height)}drawFG(t){const i=t||new Uint8Array(this.sab),s=this.ctx,e=this.width,h=this.hCoeff,a=(this.bins,e/(this.maxHearableBin+1));if("LINEAR"===this.MODE)for(let t=0;t<=this.maxHearableBin;t++){let e=i[t];const n=this.colorMap[e],r=("A"===this.WEIGHTING?this._aWeightingLUT[t]/1.4:1)*e/256*h|0,l=t*a;s.fillStyle=n,s.fillRect(this.x+l,this.y+h-r,a,r),this.tempCtx.fillStyle=n,this.tempCtx.fillRect(l,0,a,2)}else if("LOG"===this.MODE){const t=Math.log(this.maxHearableBin);for(let a=0;a<=this.maxHearableBin;a++){const n=Math.log(a+1)/t*e|0,r=Math.log(a+2)/t*e-n|0,l=("A"===this.WEIGHTING?this._aWeightingLUT[a]/1.4:1)*i[a]/256*h|0,o=this.colorMap[i[a]];s.fillStyle=o,s.fillRect(this.x+n,this.y+h-l,r,l),this.tempCtx.fillStyle=o,this.tempCtx.fillRect(n,0,r,2)}}else if("CONSTANT_Q"===this.MODE){const t=i.slice(0,this.fftSize);if(!t.every((t=>0===t))){this.lib._cqt_calc(this.dataPtr,this.dataPtr),this.lib._cqt_render_line(this.dataPtr);for(let i=0;i<canvasWidth;i++){const e=255*("A"===WEIGHTING?_aWeightingLUT[i]:1)*t[i]|0,a=e*h|0,n=getColor(e);s.fillStyle=n,s.fillRect(this.x+i,this.y+fqHeight-a,1,a),this.tempCtx.fillStyle=n,this.tempCtx.fillRect(i,0,1,2)}}}this.tempCtx.translate(0,2),this.tempCtx.drawImage(this.tempCanvas,0,0),this.tempCtx.setTransform(1,0,0,1,0,0),s.drawImage(this.tempCanvas,this.x,this.y+h)}setAudio(t){this.fftSize=t.fftSize,this.bins=t.fftSize/2,t.channels&&(this.nyquist=t.sampleRate/2,this.channels=t.channels);const i=this.makeBinFreqs();this._aWeightingLUT=i.map((t=>.5+.5*this._getAWeighting(t))),this.sab=t.sab8}_getAWeighting(t){const i=t*t;return 281061254.916*i*i/((i+424.36)*Math.sqrt((i+11599.29)*(i+544496.41))*(i+14884e4))}isRepeatedFrequencyData(t){let i=!0;for(let s=0;s<this.bins;s+=16)t[s]!==this.lastData[s]&&(i=!1),this.lastData[s]=t[s];return i}cqt_bin_to_freq(t,i,s){const e=Math.log(i),h=Math.log(s);return Math.exp(e+(t+.5)*(h-e)*(1/width))}makeBinFreqs(){const t=[];for(let i=0;i<this.bins;i++)t[i]=i/this.bins*this.nyquist,t[i]<2e4&&(this.maxHearableBin=i);return t}}class Goniometer{constructor(t,i,s,e,h){this.ctx=t,this.x=i||0,this.y=s||0,this.width=e||t.canvas.width,this.height=h||t.canvas.height,this.strokeBG="rgba(208, 130, 34, 255)",this.strokeFG="rgba(230, 200, 32, 255)"}clear(){const t=this.ctx;t.fillStyle="rgba(0, 0, 0, 1)",t.fillRect(this.x,this.y,this.width,this.height)}drawFG(t){const i=t||new Float32Array(this.sab),s=this.ctx,e=this.width/2,h=this.height/2;let a;s.lineWidth=1,s.strokeStyle=this.strokeFG,s.beginPath(),a=this.rotate45deg(i[this.fftSize],i[0]),s.moveTo(this.x+a.x*e+e,this.y+a.y*h+h);for(let t=1;t<this.fftSize;t++)a=this.rotate45deg(i[this.fftSize+t],i[t]),s.lineTo(this.x+a.x*e+e,this.y+a.y*h+h);s.stroke()}setAudio(t){this.fftSize=t.fftSize,this.sab=t.sab32}toFloat(t){return(t-128)/256/1.414213}rotate45deg(t,i){const s=this.cartesian2polar(t,i);s.angle-=.78539816;const e=this.polar2cartesian(s.radius,s.angle);return{x:e.x,y:e.y}}cartesian2polar(t,i){return{radius:Math.sqrt(t*t+i*i)/1.4142135623730951,angle:Math.atan2(i,t)}}polar2cartesian(t,i){return{x:t*Math.sin(i),y:t*Math.cos(i)}}}let dat,viz=[],raf=0;function renderLoop(t){if(raf=requestAnimationFrame(renderLoop),dat)try{viz[0].clear(),viz[0].drawFG(dat.process[0]),viz[1].clear(),viz[1].drawFG(dat.process[1]),viz[2].clear(),viz[2].drawFG(dat.process[0])}catch(t){console.error("Error in canvas.worker renderLoop",t)}}onmessage=function(t){if(t.data.process)dat=t.data;else{if(t.data.canvas){const i=t.data.canvas.getContext("2d");return viz.push(new Goniometer(i,0,0,i.canvas.width/2,i.canvas.width/2)),viz.push(new Spectrogram(i,"LINEAR","A",i.canvas.width/2,0,i.canvas.width/2,i.canvas.width/2)),void viz.push(new Waveform(i,0,i.canvas.width/2,i.canvas.width,i.canvas.height-i.canvas.width/2))}if(t.data.audioInfo){for(let i=0;i<viz.length;i++)viz[i].setAudio(t.data.audioInfo);raf||(raf=requestAnimationFrame(renderLoop))}else console.error("Unknown message:",t.data)}};\n'],{type:"text/javascript"})),{type:"module"}),this.audioSource=t,this.settings={...i,...a};let h=Math.max(screen.width,screen.height),n=Math.min(screen.width,screen.height);if((/Mobi/i.test(navigator.userAgent)||void 0!==window.safari)&&(h=Math.max(visualViewport.width,visualViewport.height),n=Math.min(visualViewport.width,visualViewport.height)),0===this.settings.fft)for(let t=5;t<16;t++)if(Math.pow(2,t)>=h*this.settings.scale){this.settings.fft=t;break}e.width=h*this.settings.scale,e.height=n*this.settings.scale,e.style.cssText="user-select:none;",e.ondblclick=t=>{e.requestFullscreen()},e.onfullscreenchange=t=>{document.fullscreenElement?e.style.cursor="none":e.style.cursor="inherit"};const r=e.transferControlToOffscreen();return this.canvasWorker.postMessage({canvas:r,devicePixelRatio},[r]),this.analyzer=new s(this.audioSource,this.canvasWorker,this.settings),this}exit(){this.canvasWorker.terminate(),0===this.analyzer.fps?cancelAnimationFrame(this.analyzer.rAF):clearInterval(this.analyzer.rAF)}}export{e as Visualizer};